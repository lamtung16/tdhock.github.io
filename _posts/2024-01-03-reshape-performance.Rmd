---
layout: post
title: Reshape performance comparison
description: Demonstration of asymptotic timing comparisons
---

```{r Ropts, echo=FALSE}
repo.dir <- normalizePath("..")
post.id <- "2024-01-03-reshape-performance"
fig.path <- file.path(repo.dir, "assets", "img", post.id)
knitr::opts_chunk$set(
  dpi=100,
  fig.path=paste0(fig.path, "/"),
  fig.width=8,
  fig.process=function(path)sub(repo.dir, "", path, fixed=TRUE),
  fig.height=4)
options(width=120)
if(FALSE){
  knitr::knit(paste0(post.id, ".Rmd"))
}
```

The goal of this blog post is to explain how to use
[atime](https://github.com/tdhock/atime) to compare the asymptotic
performance (time and memory usage) of different versions of an R
package.

## Example: wide to long reshape using nc

[nc](https://github.com/tdhock/nc), short for named capture, is a
package which supports wide to long data reshaping, using the
`capture_melt_single` and `capture_melt_multiple` functions. Both use
`data.table::melt` under the hood, so will benefit from the
[improvements I
proposed](https://github.com/Rdatatable/data.table/pull/4731), which
are currently merged into the `data.table` master branch on GitHub,
and which will hopefully soon appear in a CRAN release of `data.table`
(1.15.0). 

* nc was modified in [PR#17](https://github.com/tdhock/nc/pull/17) to
  take advantage of the new features in `data.table`. The last commit
  in that PR has SHA1 hash
  [eecced8ea46fbd26c295293fe70e761561a27726](https://github.com/tdhock/nc/pull/17/commits/eecced8ea46fbd26c295293fe70e761561a27726). [That
  version](https://github.com/tdhock/nc/blob/eecced8ea46fbd26c295293fe70e761561a27726/R/capture_melt_single.R#L27)
  of `capture_melt_single` returns the result of `data.table::melt`,
  and the `measure.vars` argument has meta-data about the variable
  columns, computed by
  [measure_single](https://github.com/tdhock/nc/blob/eecced8ea46fbd26c295293fe70e761561a27726/R/measure.R#L52).
* The first commit in that PR has SHA1 hash
  [8a045299302bd431eb9dcfacca83c2cd0e83600d](https://github.com/tdhock/nc/pull/17/commits/8a045299302bd431eb9dcfacca83c2cd0e83600d),
  and just modifies a test. That version of the code [uses a
  join](https://github.com/tdhock/nc/blob/8a045299302bd431eb9dcfacca83c2cd0e83600d/R/capture_melt_single.R#L73)
  to combine variable column meta-data with reshaped data columns, and
  is less efficient.
  
In this blog post we will compare the computational efficiency of
these two versions of nc.

## Comparison code

```{r}
library(data.table)
(iris.dt <- data.table(iris)[, flower := .I][])
(row.numbers <- rep(1:nrow(iris.dt), l=200))
(wide.dt <- iris.dt[row.numbers])
nc::capture_melt_single(wide.dt, part="Sepal|Petal", "[.]", dim="Width|Length")
melt(wide.dt, measure.vars=measure(part,dim,pattern="(Sepal|Petal)[.](Width|Length)"))
melt(wide.dt, measure.vars=measure(part,dim,sep="."))

(expr.list <- atime::atime_versions_exprs(
  "~/R/nc", 
  nc::capture_melt_single(wide.dt, part="Sepal|Petal", "[.]", dim="Width|Length"),
  "nc(old)"="8a045299302bd431eb9dcfacca83c2cd0e83600d",
  "nc(new)"="eecced8ea46fbd26c295293fe70e761561a27726"))

meas.lang <- quote(measure(part,dim))
lang.list <- list()
meas.arg.list <- list(sep=".", pattern="(Sepal|Petal)[.](Width|Length)")
for(meas.arg.name in names(meas.arg.list)){
  this.lang <- meas.lang
  this.lang[[meas.arg.name]] <- meas.arg.list[[meas.arg.name]]
  out.name <- sprintf("measure(%s)", meas.arg.name)
  lang.list[[out.name]] <- substitute(melt(wide.dt, measure.vars=M), list(M=this.lang))
}
lang.list

(atime.result <- atime::atime(
  N=10^seq(1, 6, by=0.5),
  setup={
    row.numbers <- rep(1:nrow(iris.dt), l=N)
    wide.dt <- iris.dt[row.numbers]
  },
  seconds.limit=0.01,
  expr.list=c(lang.list, expr.list)))
plot(atime.result)

(atime.refs <- atime::references_best(atime.result))
plot(atime.refs)

(atime.pred <- predict(atime.refs))
```

## Session info

```{r}
sessionInfo()
```
